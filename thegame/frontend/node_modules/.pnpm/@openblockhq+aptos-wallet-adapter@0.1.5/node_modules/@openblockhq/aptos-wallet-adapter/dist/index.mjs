// src/index.ts
import "regenerator-runtime/runtime.js";

// src/utils/scopePollingDetectionStrategy.ts
function scopePollingDetectionStrategy(detect) {
  if (typeof window === "undefined" || typeof document === "undefined")
    return;
  const disposers = [];
  function detectAndDispose() {
    const detected = detect();
    if (detected) {
      for (const dispose of disposers) {
        dispose();
      }
    }
  }
  const interval = setInterval(detectAndDispose, 1e3);
  disposers.push(() => clearInterval(interval));
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", detectAndDispose, {
      once: true
    });
    disposers.push(
      () => document.removeEventListener("DOMContentLoaded", detectAndDispose)
    );
  }
  if (document.readyState !== "complete") {
    window.addEventListener("load", detectAndDispose, { once: true });
    disposers.push(() => window.removeEventListener("load", detectAndDispose));
  }
  detectAndDispose();
}

// src/index.ts
var OpenBlockWalletName = "OpenBlock";
var OpenBlockWallet = class {
  constructor() {
    this.name = OpenBlockWalletName;
    this.url = "https://openblock.com/";
    this.icon = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDciIGhlaWdodD0iMzYiIHZpZXdCb3g9IjAgMCA0NyAzNiIgZmlsbD0ibm9uZSIKICAgIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgICA8cGF0aCBkPSJNNDYuNSAxMy4wMzMzQzQ2LjUgNS44MzUyMiA0MC42NjQ4IDAgMzMuNDY2NyAwSDAuNUwxMS4wMzcgNy42NjY2N0gyOC42MTExQzM0LjI1NjcgNy42NjY2NyAzOC44MzMzIDEyLjI0MzMgMzguODMzMyAxNy44ODg5QzM4LjgzMzMgMjMuNTM0NSAzNC4yNTY3IDI4LjExMTEgMjguNjExMSAyOC4xMTExSDExLjAzN0wwLjUgMzUuNzc3OEgzMy40NjY3QzQwLjY2NDggMzUuNzc3OCA0Ni41IDI5Ljk0MjYgNDYuNSAyMi43NDQ0VjIyLjQzMjhMNDEuOTQ4IDE3Ljg4ODlMNDYuNSAxMy4zNDA1VjEzLjAzMzNaIiBmaWxsPSIjNEEzREU2Ii8+CiAgICA8cmVjdCB4PSI5LjE0NDUzIiB5PSIxMy41NDY5IiB3aWR0aD0iMjMuODI0NSIgaGVpZ2h0PSI4LjY4ODg5IiByeD0iNC4zNDQ0NCIgZmlsbD0iIzRBM0RFNiIvPgo8L3N2Zz4KICAgIA==";
    this.providerName = "obAptos";
    if (typeof window !== "undefined") {
      this.loadSDK();
    }
  }
  loadSDK() {
    import("@openblockhq/dappsdk");
    scopePollingDetectionStrategy(() => {
      var _a, _b;
      const sdkLoaded = ((_a = window.openblock) == null ? void 0 : _a.aptos) !== void 0;
      if (sdkLoaded) {
        window.obAptos = (_b = window.openblock) == null ? void 0 : _b.aptos;
        this.provider = window.obAptos;
        console.log(`${OpenBlockWalletName} SDK loaded`);
        return true;
      }
      return false;
    });
  }
  async connect() {
    var _a;
    const methodErrorMsg = `${OpenBlockWalletName} Connect failed`;
    try {
      const accountInfo = await ((_a = this.provider) == null ? void 0 : _a.connect());
      if (!accountInfo || accountInfo.code !== void 0) {
        return Promise.reject(methodErrorMsg);
      }
      return accountInfo;
    } catch (error) {
      const errMsg = error.message;
      return Promise.reject(`${methodErrorMsg} - ${errMsg}`);
    }
  }
  async account() {
    var _a;
    const methodErrorMsg = `${OpenBlockWalletName} Account failed`;
    try {
      const response = await ((_a = this.provider) == null ? void 0 : _a.account());
      if (!response || response.code !== void 0) {
        return Promise.reject(methodErrorMsg);
      }
      return response;
    } catch (error) {
      const errMsg = error.message;
      return Promise.reject(`${methodErrorMsg} - ${errMsg}`);
    }
  }
  async disconnect() {
    var _a;
    const methodErrorMsg = `${OpenBlockWalletName} Disconnect failed`;
    try {
      await ((_a = this.provider) == null ? void 0 : _a.disconnect());
    } catch (error) {
      const errMsg = error.message;
      return Promise.reject(`${methodErrorMsg} - ${errMsg}`);
    }
  }
  async signAndSubmitTransaction(transaction, options) {
    var _a;
    const methodErrorMsg = `${OpenBlockWalletName} Sign and Submit Transaction failed`;
    try {
      const response = await ((_a = this.provider) == null ? void 0 : _a.signAndSubmitTransaction(
        transaction,
        options
      ));
      if (!response || response.code !== void 0) {
        return Promise.reject(methodErrorMsg);
      }
      if (response == null ? void 0 : response.hash) {
        return response;
      }
      return Promise.reject(methodErrorMsg);
    } catch (error) {
      const errMsg = error.message;
      return Promise.reject(`${methodErrorMsg} - ${errMsg}`);
    }
  }
  async signMessage(message) {
    var _a;
    const methodErrorMsg = `${OpenBlockWalletName} Sign Message failed`;
    try {
      if (typeof message !== "object" || !message.nonce) {
        return Promise.reject(
          `${methodErrorMsg} - Invalid signMessage Payload`
        );
      }
      const response = await ((_a = this.provider) == null ? void 0 : _a.signMessage(message));
      if (!response || response.code !== void 0) {
        return Promise.reject(methodErrorMsg);
      }
      return response;
    } catch (error) {
      const errMsg = error.message;
      return Promise.reject(`${methodErrorMsg} - ${errMsg}`);
    }
  }
  async network() {
    var _a;
    const methodErrorMsg = `${OpenBlockWalletName} Network failed`;
    try {
      const response = await ((_a = this.provider) == null ? void 0 : _a.network());
      if (!response || response.code !== void 0) {
        return Promise.reject(methodErrorMsg);
      }
      return {
        name: response.name,
        url: response.api,
        chainId: response.chainId
      };
    } catch (error) {
      const errMsg = error.message;
      return Promise.reject(`${methodErrorMsg} - ${errMsg}`);
    }
  }
  async onNetworkChange(callback) {
    var _a;
    const methodErrorMsg = `${OpenBlockWalletName} OnNetworkChange failed`;
    try {
      const handleNetworkChange = async (newNetwork) => {
        callback({
          name: newNetwork.name,
          chainId: newNetwork.chainId,
          url: newNetwork.api
        });
      };
      await ((_a = this.provider) == null ? void 0 : _a.onNetworkChange(handleNetworkChange));
    } catch (error) {
      const errMsg = error.message;
      return Promise.reject(`${methodErrorMsg} - ${errMsg}`);
    }
  }
  async onAccountChange(callback) {
    var _a;
    const methodErrorMsg = `${OpenBlockWalletName} OnAccountChange failed`;
    try {
      const handleAccountChange = async (newAccount) => {
        if (newAccount == null ? void 0 : newAccount.publicKey) {
          callback({
            publicKey: newAccount.publicKey,
            address: newAccount.address
          });
        } else {
          const response = await this.connect();
          callback({
            address: response == null ? void 0 : response.address,
            publicKey: response == null ? void 0 : response.publicKey
          });
        }
      };
      await ((_a = this.provider) == null ? void 0 : _a.onAccountChange(handleAccountChange));
    } catch (error) {
      const errMsg = error.message;
      return Promise.reject(`${methodErrorMsg} - ${errMsg}`);
    }
  }
};
export {
  OpenBlockWallet,
  OpenBlockWalletName
};
