import { NetworkName, PluginProvider } from "@aptos-labs/wallet-adapter-core";
import type {
  AccountInfo,
  AdapterPlugin,
  NetworkInfo,
  SignMessagePayload,
  SignMessageResponse,
  WalletName,
} from "@aptos-labs/wallet-adapter-core";
import { Types } from "aptos";
import "regenerator-runtime/runtime.js";

import { scopePollingDetectionStrategy } from "./utils/scopePollingDetectionStrategy";

interface OpenBlockNetworkResponse {
  api: string;
  name: NetworkName;
  chainId: string;
}

type OpenBlockSdkResponse<T> = T & {
  /**
   * error code
   * example, code = 4001, means user rejected.
   */
  code?: number;
};

// CHANGE OpenBlockWindow
interface OpenBlockWindow extends Window {
  /**
   * original openblock aptos provider
   */
  openblock?: {
    aptos: PluginProvider;
  };
  /**
   * re-associated openblock aptos provider for aptos wallet adaptor
   */
  obAptos?: PluginProvider;
}

declare const window: OpenBlockWindow;

export const OpenBlockWalletName = "OpenBlock" as WalletName<"OpenBlock">;

export class OpenBlockWallet implements AdapterPlugin {
  readonly name = OpenBlockWalletName;
  readonly url = "https://openblock.com/";
  readonly icon =
    "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDciIGhlaWdodD0iMzYiIHZpZXdCb3g9IjAgMCA0NyAzNiIgZmlsbD0ibm9uZSIKICAgIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgICA8cGF0aCBkPSJNNDYuNSAxMy4wMzMzQzQ2LjUgNS44MzUyMiA0MC42NjQ4IDAgMzMuNDY2NyAwSDAuNUwxMS4wMzcgNy42NjY2N0gyOC42MTExQzM0LjI1NjcgNy42NjY2NyAzOC44MzMzIDEyLjI0MzMgMzguODMzMyAxNy44ODg5QzM4LjgzMzMgMjMuNTM0NSAzNC4yNTY3IDI4LjExMTEgMjguNjExMSAyOC4xMTExSDExLjAzN0wwLjUgMzUuNzc3OEgzMy40NjY3QzQwLjY2NDggMzUuNzc3OCA0Ni41IDI5Ljk0MjYgNDYuNSAyMi43NDQ0VjIyLjQzMjhMNDEuOTQ4IDE3Ljg4ODlMNDYuNSAxMy4zNDA1VjEzLjAzMzNaIiBmaWxsPSIjNEEzREU2Ii8+CiAgICA8cmVjdCB4PSI5LjE0NDUzIiB5PSIxMy41NDY5IiB3aWR0aD0iMjMuODI0NSIgaGVpZ2h0PSI4LjY4ODg5IiByeD0iNC4zNDQ0NCIgZmlsbD0iIzRBM0RFNiIvPgo8L3N2Zz4KICAgIA==";
  readonly providerName = "obAptos";

  provider: PluginProvider | undefined;

  constructor() {
    if (typeof window !== "undefined") {
      this.loadSDK();
    }
  }

  private loadSDK(): void {
    import("@openblockhq/dappsdk");
    scopePollingDetectionStrategy(() => {
      const sdkLoaded = window.openblock?.aptos !== undefined;
      if (sdkLoaded) {
        window.obAptos = window.openblock?.aptos;
        this.provider = window.obAptos;
        console.log(`${OpenBlockWalletName} SDK loaded`);
        return true;
      }
      return false;
    });
  }

  async connect(): Promise<AccountInfo> {
    const methodErrorMsg = `${OpenBlockWalletName} Connect failed`;
    try {
      const accountInfo = await this.provider?.connect();

      if (
        !accountInfo ||
        (accountInfo as OpenBlockSdkResponse<AccountInfo>).code !== undefined
      ) {
        return Promise.reject(methodErrorMsg);
      }

      return accountInfo;
    } catch (error: any) {
      const errMsg = error.message;
      return Promise.reject(`${methodErrorMsg} - ${errMsg}`);
    }
  }

  async account(): Promise<AccountInfo> {
    const methodErrorMsg = `${OpenBlockWalletName} Account failed`;
    try {
      const response = await this.provider?.account();

      if (
        !response ||
        (response as OpenBlockSdkResponse<AccountInfo>).code !== undefined
      ) {
        return Promise.reject(methodErrorMsg);
      }

      return response;
    } catch (error: any) {
      const errMsg = error.message;
      return Promise.reject(`${methodErrorMsg} - ${errMsg}`);
    }
  }

  async disconnect(): Promise<void> {
    const methodErrorMsg = `${OpenBlockWalletName} Disconnect failed`;
    try {
      await this.provider?.disconnect();
    } catch (error: any) {
      const errMsg = error.message;
      return Promise.reject(`${methodErrorMsg} - ${errMsg}`);
    }
  }

  async signAndSubmitTransaction(
    transaction: Types.TransactionPayload,
    options?: any
  ): Promise<{ hash: Types.HexEncodedBytes }> {
    const methodErrorMsg = `${OpenBlockWalletName} Sign and Submit Transaction failed`;
    try {
      const response = await this.provider?.signAndSubmitTransaction(
        transaction,
        options // currently there is no available options yet.
      );

      if (
        !response ||
        (response as OpenBlockSdkResponse<{ hash: string }>).code !== undefined
      ) {
        return Promise.reject(methodErrorMsg);
      }

      if ((response as { hash: Types.HexEncodedBytes })?.hash) {
        return response as { hash: Types.HexEncodedBytes };
      }

      return Promise.reject(methodErrorMsg);
    } catch (error: any) {
      const errMsg = error.message;
      return Promise.reject(`${methodErrorMsg} - ${errMsg}`);
    }
  }

  async signMessage(message: SignMessagePayload): Promise<SignMessageResponse> {
    const methodErrorMsg = `${OpenBlockWalletName} Sign Message failed`;
    try {
      if (typeof message !== "object" || !message.nonce) {
        return Promise.reject(
          `${methodErrorMsg} - Invalid signMessage Payload`
        );
      }

      const response = await this.provider?.signMessage(message);

      if (
        !response ||
        (response as OpenBlockSdkResponse<SignMessageResponse>).code !==
          undefined
      ) {
        return Promise.reject(methodErrorMsg);
      }

      return response;
    } catch (error: any) {
      const errMsg = error.message;
      return Promise.reject(`${methodErrorMsg} - ${errMsg}`);
    }
  }

  async network(): Promise<NetworkInfo> {
    const methodErrorMsg = `${OpenBlockWalletName} Network failed`;
    try {
      const response =
        await (this.provider?.network() as unknown as OpenBlockNetworkResponse);

      if (
        !response ||
        (response as OpenBlockSdkResponse<OpenBlockNetworkResponse>).code !==
          undefined
      ) {
        return Promise.reject(methodErrorMsg);
      }

      return {
        name: response.name,
        url: response.api,
        chainId: response.chainId,
      };
    } catch (error: any) {
      const errMsg = error.message;
      return Promise.reject(`${methodErrorMsg} - ${errMsg}`);
    }
  }

  async onNetworkChange(callback: any): Promise<void> {
    const methodErrorMsg = `${OpenBlockWalletName} OnNetworkChange failed`;
    try {
      const handleNetworkChange = async (
        newNetwork: OpenBlockNetworkResponse
      ): Promise<void> => {
        callback({
          name: newNetwork.name,
          chainId: newNetwork.chainId,
          url: newNetwork.api,
        });
      };
      await this.provider?.onNetworkChange(handleNetworkChange as any);
    } catch (error: any) {
      const errMsg = error.message;
      return Promise.reject(`${methodErrorMsg} - ${errMsg}`);
    }
  }

  async onAccountChange(callback: any): Promise<void> {
    const methodErrorMsg = `${OpenBlockWalletName} OnAccountChange failed`;
    try {
      const handleAccountChange = async (
        newAccount: AccountInfo
      ): Promise<void> => {
        if (newAccount?.publicKey) {
          callback({
            publicKey: newAccount.publicKey,
            address: newAccount.address,
          });
        } else {
          const response = await this.connect();
          callback({
            address: response?.address,
            publicKey: response?.publicKey,
          });
        }
      };
      await this.provider?.onAccountChange(handleAccountChange);
    } catch (error: any) {
      const errMsg = error.message;
      return Promise.reject(`${methodErrorMsg} - ${errMsg}`);
    }
  }
}
